#!/bin/bash

container=$1
shift

for n in $* ; do
    if [[ -e ${n} ]]; then
	size=$(du -b ${n} | awk '{print $1}')
    else
	size=$(swift list -l --prefix=${n} ${container} | head -n 1 | awk '{print $1}')
    fi
    if [[ ! -e ${n}.md5} ]] ; then
	find ${n} | xargs -n1 md5sum 2> /dev/null > ${n}.md5
    fi
    [[ -e ${n} ]] && mv ${n}{,.old}
    time_it download-${size}-oss swift download -q ${container} ${n}
    if [[ -s ${olddir}/${n}.md5 ]]; then
	failed=$(md5sum -c ${olddir}/${n}.md5 | grep -c FAILED)
	if [[ ${failed} != 0 ]]; then
	    echo $(( $(cat download-oss.failed 2> /dev/null) + ${failed} )) > download-oss.failed
	fi
    fi
    [[ -e ${n}.old ]] && rm ${n}.old
done
